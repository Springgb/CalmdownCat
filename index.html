<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>æ·¡å®šå®¶é•¿ - æƒ…ç»ªè£åˆ¤</title>  
    <style>  
        /* --- æ ·å¼ä¿æŒä¸å˜ï¼Œç»´æŒä½ å–œæ¬¢çš„é£æ ¼ --- */  
        :root {  
            --bg-color: #FFF0F5;  
            --card-bg: #ffffff;  
            --primary-color: #FF8A80;  
            --danger-color: #d32f2f;  
        }  
  
        body {  
            margin: 0; padding: 0; font-family: 'Microsoft YaHei', sans-serif;  
            background-color: var(--bg-color);  
            background-image: radial-gradient(#FFCDD2 10%, transparent 10%);  
            background-size: 20px 20px;  
            display: flex; justify-content: center; align-items: center; height: 100vh;  
            overflow: hidden; user-select: none;  
        }  
  
        .container {  
            background: var(--card-bg); padding: 20px; border-radius: 20px;  
            box-shadow: 0 10px 25px rgba(255, 138, 128, 0.3);  
            text-align: center; width: 90%; max-width: 400px; position: relative;  
            border: 3px solid #FFCCBC;  
        }  
  
        h1 { color: #E91E63; font-size: 24px; margin-bottom: 5px; }  
          
        .mascot-container {  
            width: 180px; height: 180px; margin: 10px auto;  
            display: flex; align-items: center; justify-content: center;  
        }  
        .mascot-img {  
            max-width: 100%; max-height: 100%; object-fit: contain;  
        }  
  
        .status-bar {  
            height: 18px; background: #FFEBEE; border-radius: 10px;  
            margin: 15px auto; width: 95%; overflow: hidden;  
            border: 1px solid #FFCDD2;  
        }  
        .volume-level {  
            height: 100%; width: 0%;   
            background: linear-gradient(90deg, #81D4FA, #29B6F6);  
            border-radius: 8px; transition: width 0.1s linear;  
        }  
        .volume-level.danger {  
            background: linear-gradient(90deg, #FF7043, #F44336);  
        }  
  
        .slider-container {  
            margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;  
            font-size: 14px; color: #5D4037;  
        }  
  
        .btn-start {  
            background-color: var(--primary-color); color: white; border: none;  
            padding: 12px 40px; border-radius: 50px; font-size: 18px; font-weight: bold;  
            box-shadow: 0 4px #E57373; cursor: pointer; margin-top: 10px;  
        }  
        .btn-start:disabled { background-color: #cfd8dc; box-shadow: none; color: #999; }  
  
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */  
        .live-indicator {  
            display: inline-block; width: 10px; height: 10px; background: #ccc; border-radius: 50%;  
            margin-right: 5px;  
        }  
        .live-indicator.on {  
            background: #4CAF50;  
            box-shadow: 0 0 8px #4CAF50;  
            animation: blink 1s infinite;  
        }  
        @keyframes blink { 0%{opacity:0.5} 50%{opacity:1} 100%{opacity:0.5} }  
  
        .debug-text {   
            font-size: 12px; color: #999; margin-top: 10px;   
            background: #fff; padding: 5px; border-radius: 5px;  
            word-break: break-all; min-height: 30px; max-height: 50px; overflow: hidden;  
        }  
  
        .overlay {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            display: flex; justify-content: center; align-items: center;  
            z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s;  
            background: rgba(0,0,0,0.8);  
        }  
        .overlay.active { opacity: 1; pointer-events: all; }  
          
        .card {  
            background: white; padding: 20px; border-radius: 20px; width: 80%;  
            text-align: center; transform: scale(0.8); transition: transform 0.3s;  
            border: 5px solid;  
        }  
        .overlay.active .card { transform: scale(1); }  
        .overlay.mode-red .card { border-color: #d32f2f; }  
        .overlay.mode-yellow .card { border-color: #FBC02D; }  
  
        .card-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 10px; }  
        .card-title { font-size: 24px; font-weight: 900; margin: 10px 0; display: block; }  
        .card-msg { font-size: 16px; color: #455a64; font-weight: bold; line-height: 1.5; margin-bottom: 20px; }  
          
        .mode-red .card-title { color: #d32f2f; }  
        .mode-yellow .card-title { color: #FBC02D; }  
  
        .btn-calm {  
            border: none; color: white; padding: 10px 30px; border-radius: 25px;  
            font-size: 16px; font-weight: bold; background: #90A4AE;  
        }  
    </style>  
</head>  
<body>  
  
    <div class="container">  
        <h1>ğŸ± çŒ«å’ªæƒ…ç»ªè£åˆ¤</h1>  
          
        <div class="mascot-container">  
            <img src="assets/cat_normal.png" id="mascotImg" class="mascot-img" alt="ç­‰å¾…åŠ è½½...">  
        </div>  
          
        <div class="status-bar">  
            <div class="volume-level" id="volumeLevel"></div>  
        </div>  
  
        <div class="slider-container">  
            <span>ğŸ¤ çµæ•åº¦:</span>  
            <input type="range" id="sensSlider" min="1" max="100" value="85">  
            <span id="sensVal">85</span>  
        </div>  
  
        <button class="btn-start" id="startBtn">ç‚¹å‡»å¼€å§‹</button>  
          
        <div style="margin-top:10px; font-size: 14px; color: #666;">  
            <span class="live-indicator" id="liveDot"></span>  
            <span id="statusText">å‡†å¤‡å°±ç»ª</span>  
        </div>  
  
        <div class="debug-text" id="debugInfo">ç­‰å¾…æŒ‡ä»¤...</div>  
    </div>  
  
    <audio id="whistleAudio" src="assets/whistle.mp3" preload="auto"></audio>  
  
    <div class="overlay" id="overlay">  
        <div class="card">  
            <img src="" id="cardImg" class="card-img">  
            <span class="card-title" id="cardTitle"></span>  
            <div class="card-msg" id="cardMsg"></div>  
            <button class="btn-calm" onclick="dismissAlert()">æˆ‘å†·é™äº†</button>  
        </div>  
    </div>  
  
    <script>  
        // === èµ„æºé…ç½® ===  
        const IMAGES = {  
            NORMAL: "assets/cat_normal.png",   
            YELLOW: "assets/card_yellow.png",   
            RED:   "assets/card_red.png"  
        };  
  
        // === è¯åº“ (ä¸è€çƒ¦+è„è¯) ===  
        const WORDS = {  
            FATAL: ["çŒª","ç¬¨çŒª","è ¢é©´","åºŸç‰©","è ¢è´§","æ»š","å»æ­»","æ²¡è„‘å­","å¦ˆçš„","å§æ§½","ç¥ç»ç—…","é—­å˜´","shit","fuck"],  
            INSULT: ["ç¬¨","è ¢","å‘†","ç™½ç—´","æ™ºéšœ","æ²¡ç”¨","æ²¡å‡ºæ¯","æ— èƒ½","æ²¡æ•‘","ç™½æ­","ä¸¢äºº"],  
            IMPATIENT: ["å¿«ç‚¹","ç£¨è¹­","çƒ¦","åŒ","æ‡’å¾—","ä¸ç®¡","æ°”æ­»","å‡ é","è€³æœµ","å¬ä¸æ‡‚","æ‡‚ä¸æ‡‚"]  
        };  
        const CONTEXT = ["ä½œä¸š","é¢˜","å­¦","è€ƒ","å†™","ç®—","è¯»","é”™","æ•™","è¯•å·"];  
  
        let audioCtx, analyser, mic, scriptNode, recognition;  
        let isRunning = false;  
        let lastAlertTime = 0;  
        let synth = window.speechSynthesis;  
        let shoutFrames = 0;   
        let restartTimer = null; // ç”¨äºé˜²æ­¢è¯†åˆ«å¼•æ“æ­»æ‰  
  
        const els = {  
            btn: document.getElementById('startBtn'),  
            mascot: document.getElementById('mascotImg'),  
            volBar: document.getElementById('volumeLevel'),  
            debug: document.getElementById('debugInfo'),  
            overlay: document.getElementById('overlay'),  
            cardImg: document.getElementById('cardImg'),  
            title: document.getElementById('cardTitle'),  
            msg: document.getElementById('cardMsg'),  
            audio: document.getElementById('whistleAudio'),  
            slider: document.getElementById('sensSlider'),  
            val: document.getElementById('sensVal'),  
            dot: document.getElementById('liveDot'),  
            status: document.getElementById('statusText')  
        };  
  
        els.mascot.src = IMAGES.NORMAL;  
        els.slider.oninput = function() { els.val.innerText = this.value; };  
  
        // === æ ¸å¿ƒå¯åŠ¨é€»è¾‘ ===  
        els.btn.addEventListener('click', async () => {  
            if (isRunning) return;  
            els.btn.innerText = "æ­£åœ¨å¯åŠ¨...";  
            els.btn.disabled = true;  
  
            try {  
                // 1. é¢„çƒ­éŸ³é¢‘ (æ¿€æ´»iOS/AndroidéŸ³é¢‘ç¯å¢ƒ)  
                els.audio.volume = 0;  
                await els.audio.play();  
                els.audio.pause();  
                els.audio.currentTime = 0;  
                els.audio.volume = 1.0;  
  
                // 2. å¯åŠ¨ AudioContext  
                const AudioContext = window.AudioContext || window.webkitAudioContext;  
                audioCtx = new AudioContext();  
                if (audioCtx.state === 'suspended') await audioCtx.resume();  
  
                // 3. å¯åŠ¨éº¦å…‹é£æµ  
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });  
                  
                startVolumeLoop(stream);  
                initSpeechEngine(); // åˆå§‹åŒ–è¯­éŸ³å¼•æ“  
  
                isRunning = true;  
                els.btn.style.display = 'none';  
                els.dot.classList.add('on');  
                els.status.innerText = "ç›‘å¬ä¸­...";  
                els.debug.innerText = "ç³»ç»Ÿæ­£å¸¸ï¼Œè¯·ä¿æŒç½‘ç»œè¿æ¥";  
  
            } catch (err) {  
                console.error(err);  
                alert("å¯åŠ¨å¤±è´¥ï¼šè¯·æ£€æŸ¥éº¦å…‹é£æƒé™æˆ–ç½‘ç»œã€‚\næ³¨æ„ï¼šè¯­éŸ³è¯†åˆ«éœ€è¦è”ç½‘ï¼");  
                els.btn.innerText = "é‡è¯•";  
                els.btn.disabled = false;  
            }  
        });  
  
        // === 1. éŸ³é‡ç›‘æ§ (çº¢ç‰Œ) ===  
        function startVolumeLoop(stream) {  
            analyser = audioCtx.createAnalyser();  
            mic = audioCtx.createMediaStreamSource(stream);  
            scriptNode = audioCtx.createScriptProcessor(2048, 1, 1);  
            analyser.smoothingTimeConstant = 0.3;  
            analyser.fftSize = 1024;  
  
            mic.connect(analyser);  
            analyser.connect(scriptNode);  
            scriptNode.connect(audioCtx.destination);  
  
            scriptNode.onaudioprocess = () => {  
                if (!isRunning) return; // å¦‚æœæš‚åœäº†å°±ä¸å¤„ç†  
  
                const array = new Uint8Array(analyser.frequencyBinCount);  
                analyser.getByteFrequencyData(array);  
                let values = 0;  
                for (let i=0; i<array.length; i++) values+=array[i];  
                const avg = values / array.length;  
                  
                // UI æ›´æ–°  
                let percent = Math.min(avg * 3, 100);  
                els.volBar.style.width = percent + "%";  
                if (percent > 80) els.volBar.classList.add('danger');  
                else els.volBar.classList.remove('danger');  
  
                // åˆ¤å®šé€»è¾‘  
                const threshold = 115 - parseInt(els.slider.value);  
                if (avg > threshold) shoutFrames++;  
                else shoutFrames = Math.max(0, shoutFrames - 2);  
  
                if (shoutFrames > 15) {  
                    trigger('red', null);  
                    shoutFrames = 0;  
                }  
            };  
        }  
  
        // === 2. è¯­éŸ³è¯†åˆ« (é»„ç‰Œ) - å¼ºåŠ›é‡å¯ç‰ˆ ===  
        function initSpeechEngine() {  
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;  
            if (!SpeechRecognition) {  
                els.debug.innerText = "âš ï¸ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è½¬æ–‡å­—ï¼Œåªèƒ½æ£€æµ‹éŸ³é‡ã€‚";  
                return;  
            }  
  
            recognition = new SpeechRecognition();  
            recognition.continuous = false; // å®‰å“ç«¯å»ºè®®è®¾ä¸ºfalseï¼Œé…åˆonendé‡å¯ï¼Œæ›´ç¨³å®š  
            recognition.interimResults = true;  
            recognition.lang = 'zh-CN';  
              
            recognition.onstart = () => {   
                els.dot.classList.add('on');   
                els.status.innerText = "æ­£åœ¨å¬...";  
            };  
              
            recognition.onend = () => {   
                els.dot.classList.remove('on');  
                // åªè¦ç¨‹åºè¿˜åœ¨è¿è¡Œï¼Œå°±ç«‹åˆ»é‡å¯è¯†åˆ«  
                if(isRunning) {  
                    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹é¿å…æ­»å¾ªç¯å¡æ­»  
                    setTimeout(() => {  
                        try { recognition.start(); } catch(e){}  
                    }, 200);  
                }  
            };  
  
            recognition.onresult = (e) => {  
                let text = '';  
                for (let i = e.resultIndex; i < e.results.length; ++i) {  
                    text += e.results[i][0].transcript;  
                }  
                if(text) {  
                    // æ˜¾ç¤ºå¬åˆ°çš„æœ€åå‡ ä¸ªå­—ï¼Œæ–¹ä¾¿è°ƒè¯•  
                    els.debug.innerText = "ğŸ‘‚: " + text.slice(-10);  
                    checkWords(text);  
                }  
            };  
  
            try { recognition.start(); } catch(e) {}  
        }  
  
        function checkWords(text) {  
            // æ˜Ÿå·å±è”½è¯å¤„ç†ï¼ˆæœ‰äº›æ‰‹æœºä¼šè‡ªåŠ¨æŠŠè„è¯å˜æˆ***ï¼‰  
            if(text.includes('*') || text.includes('ï¼Š')) return trigger('yellow', "è„è¯(å·²å±è”½)");  
              
            // 1. è‡´å‘½è¯æ£€æµ‹  
            for(let w of WORDS.FATAL) if(text.includes(w)) return trigger('yellow', w);  
              
            // 2. åœºæ™¯è¯+ç»„åˆè¯æ£€æµ‹  
            if(CONTEXT.some(c => text.includes(c))) {  
                for(let w of [...WORDS.INSULT, ...WORDS.IMPATIENT]) {  
                    if(text.includes(w)) return trigger('yellow', w);  
                }  
            }  
        }  
  
        // === è§¦å‘è­¦å‘Šï¼ˆå…³é”®ä¿®æ”¹ï¼šæš‚åœç›‘å¬ï¼‰ ===  
        function trigger(mode, word) {  
            // å†·å´æ—¶é—´  
            if (Date.now() - lastAlertTime < 3000) return;  
            lastAlertTime = Date.now();  
  
            // 1. æš‚åœç›‘å¬çŠ¶æ€ï¼Œé˜²æ­¢è‡ªå·±å¬åˆ°è‡ªå·±æŠ¥è­¦ï¼Œå¯¼è‡´æ­»å¾ªç¯  
            isRunning = false;   
            if(recognition) recognition.stop();  
            els.dot.classList.remove('on');  
            els.status.innerText = "è­¦å‘Šä¸­(æš‚åœç›‘å¬)";  
  
            // 2. æ˜¾ç¤ºå¼¹çª—  
            els.overlay.className = `overlay mode-${mode} active`;  
            els.cardImg.src = (mode === 'yellow') ? IMAGES.YELLOW : IMAGES.RED;  
            els.title.innerText = (mode === 'yellow') ? "é»„ç‰Œè­¦å‘Šï¼" : "çº¢ç‰Œè­¦å‘Šï¼";  
              
            let tip = "";  
            if(mode === 'yellow') {  
                tip = `æ£€æµ‹åˆ°ï¼š${word}ã€‚è¯·æ³¨æ„è¯­è¨€æ–‡æ˜ï¼`;  
            } else {  
                tip = "å—“é—¨å¤ªå¤§äº†ï¼è¯·é™æ¸©ï¼";  
            }  
            els.msg.innerText = tip;  
              
            // 3. æ’­æ”¾å£°éŸ³  
            try{ els.audio.currentTime=0; els.audio.play(); }catch(e){}  
              
            // 4. æ’­æŠ¥è¯­éŸ³  
            if(synth.speaking) synth.cancel();  
            let u = new SpeechSynthesisUtterance(tip);  
            u.lang = 'zh-CN';  
            synth.speak(u);  
        }  
  
        // === æ¢å¤ç›‘å¬ï¼ˆå…³é”®ä¿®æ”¹ï¼šå½»åº•é‡å¯ï¼‰ ===  
        function dismissAlert() {  
            els.overlay.classList.remove('active');  
            synth.cancel(); // åœæ­¢æ’­æŠ¥  
              
            // æ¢å¤çŠ¶æ€  
            shoutFrames = 0;  
            isRunning = true;  
            els.debug.innerText = "æ­£åœ¨æ¢å¤è¿æ¥...";  
              
            // ç¡®ä¿ AudioContext æ˜¯æ¿€æ´»çš„  
            if (audioCtx.state === 'suspended') audioCtx.resume();  
  
            // é‡å¯è¯­éŸ³è¯†åˆ«  
            if (recognition) {  
                try { recognition.start(); } catch(e) {}  
            }  
        }  
    </script>  
</body>  
</html>  
