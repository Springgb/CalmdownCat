<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>æ·¡å®šå®¶é•¿ - æƒ…ç»ªè£åˆ¤</title>  
    <style>  
        :root {  
            --bg-color: #FFF0F5;  
            --card-bg: #ffffff;  
            --primary-color: #FF8A80;  
            --danger-color: #d32f2f;  
        }  
  
        body {  
            margin: 0; padding: 0; font-family: 'Microsoft YaHei', sans-serif;  
            background-color: var(--bg-color);  
            background-image: radial-gradient(#FFCDD2 10%, transparent 10%);  
            background-size: 20px 20px;  
            display: flex; justify-content: center; align-items: center; height: 100vh;  
            overflow: hidden; user-select: none;  
        }  
  
        .container {  
            background: var(--card-bg); padding: 20px; border-radius: 20px;  
            box-shadow: 0 10px 25px rgba(255, 138, 128, 0.3);  
            text-align: center; width: 90%; max-width: 400px; position: relative;  
            border: 3px solid #FFCCBC;  
        }  
  
        h1 { color: #E91E63; font-size: 24px; margin-bottom: 5px; }  
          
        .mascot-container {  
            width: 180px; height: 180px; margin: 10px auto;  
            display: flex; align-items: center; justify-content: center;  
        }  
        .mascot-img {  
            max-width: 100%; max-height: 100%; object-fit: contain;  
        }  
  
        .status-bar {  
            height: 18px; background: #FFEBEE; border-radius: 10px;  
            margin: 15px auto; width: 95%; overflow: hidden;  
            border: 1px solid #FFCDD2;  
        }  
        .volume-level {  
            height: 100%; width: 0%;   
            background: linear-gradient(90deg, #81D4FA, #29B6F6);  
            border-radius: 8px; transition: width 0.1s linear;  
        }  
        .volume-level.danger {  
            background: linear-gradient(90deg, #FF7043, #F44336);  
        }  
  
        .slider-container {  
            margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;  
            font-size: 14px; color: #5D4037;  
        }  
  
        .btn-start {  
            background-color: var(--primary-color); color: white; border: none;  
            padding: 12px 40px; border-radius: 50px; font-size: 18px; font-weight: bold;  
            box-shadow: 0 4px #E57373; cursor: pointer; margin-top: 10px;  
        }  
        .btn-start:disabled { background-color: #cfd8dc; box-shadow: none; color: #999; }  
  
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */  
        .live-indicator {  
            display: inline-block; width: 10px; height: 10px; background: #ccc; border-radius: 50%;  
            margin-right: 5px;  
        }  
        .live-indicator.on {  
            background: #4CAF50; box-shadow: 0 0 8px #4CAF50; animation: blink 1s infinite;  
        }  
        @keyframes blink { 0%{opacity:0.5} 50%{opacity:1} 100%{opacity:0.5} }  
  
        .debug-text {   
            font-size: 12px; color: #999; margin-top: 10px;   
            background: #fff; padding: 5px; border-radius: 5px;  
            word-break: break-all; min-height: 30px; max-height: 50px; overflow: hidden;  
        }  
  
        .overlay {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            display: flex; justify-content: center; align-items: center;  
            z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s;  
            background: rgba(0,0,0,0.8);  
        }  
        .overlay.active { opacity: 1; pointer-events: all; }  
          
        .card {  
            background: white; padding: 20px; border-radius: 20px; width: 80%;  
            text-align: center; transform: scale(0.8); transition: transform 0.3s;  
            border: 5px solid;  
        }  
        .overlay.active .card { transform: scale(1); }  
        .overlay.mode-red .card { border-color: #d32f2f; }  
        .overlay.mode-yellow .card { border-color: #FBC02D; }  
  
        .card-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 10px; }  
        .card-title { font-size: 24px; font-weight: 900; margin: 10px 0; display: block; }  
        .card-msg { font-size: 16px; color: #455a64; font-weight: bold; line-height: 1.5; margin-bottom: 20px; white-space: pre-wrap;}  
          
        .mode-red .card-title { color: #d32f2f; }  
        .mode-yellow .card-title { color: #FBC02D; }  
  
        .btn-calm {  
            border: none; color: white; padding: 10px 30px; border-radius: 25px;  
            font-size: 16px; font-weight: bold; background: #90A4AE;  
        }  
    </style>  
</head>  
<body>  
  
    <div class="container">  
        <h1>ğŸ± çŒ«å’ªæƒ…ç»ªè£åˆ¤</h1>  
          
        <div class="mascot-container">  
            <img src="assets/cat_normal.png" id="mascotImg" class="mascot-img" alt="ç­‰å¾…åŠ è½½...">  
        </div>  
          
        <div class="status-bar">  
            <div class="volume-level" id="volumeLevel"></div>  
        </div>  
  
        <div class="slider-container">  
            <span>ğŸ¤ çµæ•åº¦:</span>  
            <input type="range" id="sensSlider" min="1" max="100" value="85">  
            <span id="sensVal">85</span>  
        </div>  
  
        <button class="btn-start" id="startBtn">ç‚¹å‡»å¼€å§‹</button>  
          
        <div style="margin-top:10px; font-size: 14px; color: #666;">  
            <span class="live-indicator" id="liveDot"></span>  
            <span id="statusText">å‡†å¤‡å°±ç»ª</span>  
        </div>  
  
        <div class="debug-text" id="debugInfo">ç­‰å¾…æŒ‡ä»¤...</div>  
    </div>  
  
    <audio id="whistleAudio" src="assets/whistle.mp3" preload="auto"></audio>  
  
    <div class="overlay" id="overlay">  
        <div class="card">  
            <img src="" id="cardImg" class="card-img">  
            <span class="card-title" id="cardTitle"></span>  
            <div class="card-msg" id="cardMsg"></div>  
            <button class="btn-calm" onclick="dismissAlert()">æˆ‘å†·é™äº†</button>  
        </div>  
    </div>  
  
    <script>  
        // === 1. èµ„æºé…ç½® ===  
        const IMAGES = {  
            NORMAL: "assets/cat_normal.png",   
            YELLOW: "assets/card_yellow.png",   
            RED:   "assets/card_red.png"  
        };  
  
        // === 2. æ ¸å¿ƒè¯åº“ (ä¸­æ–‡ + è‹±æ–‡å…¨é‡) ===  
        // æ³¨æ„ï¼šæ‰€æœ‰è‹±æ–‡å·²è½¬æ¢ä¸ºå°å†™ï¼Œæ–¹ä¾¿æ¯”å¯¹  
        const BAD_WORDS = [  
            // --- ä¸­æ–‡é«˜é¢‘è¯ ---  
            "çŒª","ç¬¨çŒª","è ¢é©´","åºŸç‰©","è ¢è´§","æ»š","å»æ­»","æ²¡è„‘å­","å¦ˆçš„","å§æ§½","ç¥ç»ç—…","é—­å˜´","å‚»å­","ä½èƒ½","åƒåœ¾",  
            "ç¬¨","è ¢","å‘†","å‚»","ç™½ç—´","æ™ºéšœ","æ²¡ç”¨","æ²¡å‡ºæ¯","æ— èƒ½","æ²¡æ•‘","ç™½æ­","ä¸¢äºº","æ‰«å¤§è¡—","æ¬ç –","æ¡åƒåœ¾","è¦é¥­",  
            "å¿«ç‚¹","ç£¨è¹­","çƒ¦","åŒ","æ‡’å¾—","ä¸ç®¡","æ°”æ­»","å‡ é","è€³æœµ","å¬ä¸æ‡‚","æ‡‚ä¸æ‡‚","å†è¯•","åˆ«ç¡",  
              
            // --- è‹±æ–‡é«˜é¢‘è¯ (Base) ---  
            "damn", "dammit", "hell", "holy hell", "shit", "bullshit", "crap", "bullcrap",  
            "fuck", "fucking", "fuck off", "ass", "asshole", "dumbass", "jackass",  
            "bitch", "bastard", "piss", "piss off", "screw", "screw up", "screw you",  
              
            // --- è‹±æ–‡æ™ºåŠ›è´¬ä½ (Insult) ---  
            "stupid", "idiot", "moron", "retard", "retarded", "dimwit", "blockhead", "knucklehead",  
            "brainless", "no brain", "empty-headed", "thickheaded",   
            "incompetent", "useless", "worthless", "hopeless", "slacker", "ignorant", "uneducated", "fool", "foolish",  
  
            // --- è‹±æ–‡å¥å­ç‰‡æ®µ (Phrase Fragments) ---  
            "what the hell", "for fuck's sake", "son of a bitch", "you're stupid", "stupid kid",   
            "stupid idiot", "total idiot", "you're an idiot", "complete moron", "you're retarded",   
            "you're brainless", "you're so thick", "you're slow", "slow learner", "you're incompetent",  
            "you're useless", "you're worthless", "good for nothing", "can't do anything right",  
            "never get it right", "how stupid can you be", "are you brain dead", "do you have a brain",  
            "use your brain", "waste of time", "waste of space", "for crying out loud", "good grief",  
            "give me a break", "you're impossible", "can't you do anything", "hopeless case", "lost cause",  
            "you're a mess", "what a mess", "you're careless", "so careless", "reckless", "you're lazy",  
            "lazy bum", "you're a slacker", "you're ignorant", "you're a fool", "shut up", "shut the hell up",  
            "shut your mouth", "leave me alone", "get out of my sight", "stop bothering me",   
            "quit wasting my time", "what's wrong with you", "what's your problem", "are you crazy",  
            "are you insane", "you're nuts", "driving me crazy", "driving me nuts", "this is ridiculous",  
            "you're ridiculous", "you're pathetic", "so pathetic", "you're disgusting", "you're so annoying",  
            "such a nuisance", "get a clue", "wake up", "snap out of it", "don't be stupid",  
            "don't be an idiot", "make me sick", "you're a nightmare", "why can't you be normal", "why are you so difficult"  
        ];  
  
        // === 3. å¹½é»˜åŠæ…°è¯­å½•åº“ ===  
        const FUNNY_TIPS = {  
            YELLOW: [   
                "äº²ç”Ÿçš„ï¼Œäº²ç”Ÿçš„ï¼Œå¿ä½ï¼\nè«ç”Ÿæ°”ï¼Œæ°”å‡ºç—…æ¥æ— äººæ›¿ã€‚",  
                "é»˜å¿µä¸‰éï¼š\næˆ‘çˆ±å­©å­ï¼Œå­©å­çˆ±æˆ‘ï¼Œä½œä¸šæ˜¯æµ®äº‘ã€‚",  
                "æ·±å‘¼å¸...\næƒ³æƒ³å­©å­åˆšå‡ºç”Ÿæ—¶é‚£å¯çˆ±çš„æ ·å­ã€‚",  
                "è¾…å¯¼ä½œä¸šæ˜¯æ¸¡åŠ«ï¼Œ\nå¿ƒæ€è¦ç¨³ï¼Œå“ªæ€•å¿ƒé‡ŒMMPï¼Œè„¸ä¸Šç¬‘å˜»å˜»ã€‚",  
                "è¯·æ³¨æ„æªè¾ï¼\næ‚¨ç°åœ¨çš„æ ·å­ï¼Œå°±æ˜¯å­©å­æœªæ¥çš„æ ·å­ã€‚",  
                "æ·¡å®šï¼\nçˆ±å› æ–¯å¦å°æ—¶å€™ä¹ŸæŒºç¬¨çš„ï¼ˆå¤§æ¦‚å§ï¼‰ã€‚"  
            ],  
            RED: [  
                "æ¥¼ä¸‹é‚»å±…è¦æŠ¥è­¦äº†ï¼\nå—“é—¨å¤§ä¸ä»£è¡¨é“ç†å¯¹ã€‚",  
                "æ‚¨çš„ç‹®å¼åŠŸåˆç²¾è¿›äº†ï¼Œ\nä½†å­©å­çš„è€³è†œå—ä¸äº†å•Šï¼",  
                "é™æ¸©ï¼é™æ¸©ï¼\nè¡€å‹è®¡è¦çˆ†è¡¨äº†ï¼",  
                "æ¸©æŸ”æ‰æ˜¯æœ€å¼ºå¤§çš„åŠ›é‡ï¼Œ\nå°å£°ç‚¹è¯´ï¼Œå­©å­åè€Œå¬å¾—è¿›ã€‚",  
                "å“æ­»å®å®äº†ï¼\nå’±æ˜¯æ–‡æ˜å®¶é•¿ï¼Œä¸ææ²³ä¸œç‹®å¼ã€‚",  
                "è¾“å‡ºå…¨é å¼ï¼Ÿ\nå—“å­ä¸è¦äº†å—ï¼Ÿå–å£æ°´å†·é™ä¸‹ã€‚"  
            ]  
        };  
  
        let audioCtx, analyser, mic, scriptNode, recognition;  
        let isRunning = false;  
        let lastAlertTime = 0;  
        let synth = window.speechSynthesis;  
        let shoutFrames = 0;   
  
        const els = {  
            btn: document.getElementById('startBtn'),  
            mascot: document.getElementById('mascotImg'),  
            volBar: document.getElementById('volumeLevel'),  
            debug: document.getElementById('debugInfo'),  
            overlay: document.getElementById('overlay'),  
            cardImg: document.getElementById('cardImg'),  
            title: document.getElementById('cardTitle'),  
            msg: document.getElementById('cardMsg'),  
            audio: document.getElementById('whistleAudio'),  
            slider: document.getElementById('sensSlider'),  
            val: document.getElementById('sensVal'),  
            dot: document.getElementById('liveDot'),  
            status: document.getElementById('statusText')  
        };  
  
        els.mascot.src = IMAGES.NORMAL;  
        els.slider.oninput = function() { els.val.innerText = this.value; };  
  
        // === å¯åŠ¨é€»è¾‘ ===  
        els.btn.addEventListener('click', async () => {  
            if (isRunning) return;  
            els.btn.innerText = "å¯åŠ¨ä¸­...";  
            els.btn.disabled = true;  
  
            try {  
                // é¢„çƒ­éŸ³é¢‘  
                els.audio.volume = 0;  
                await els.audio.play();  
                els.audio.pause();  
                els.audio.currentTime = 0;  
                els.audio.volume = 1.0;  
  
                const AudioContext = window.AudioContext || window.webkitAudioContext;  
                audioCtx = new AudioContext();  
                if (audioCtx.state === 'suspended') await audioCtx.resume();  
  
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });  
                  
                startVolumeLoop(stream);  
                initSpeechEngine();  
  
                isRunning = true;  
                els.btn.style.display = 'none';  
                els.dot.classList.add('on');  
                els.status.innerText = "æ­£åœ¨ç›‘å¬...";  
                els.debug.innerText = "âœ… ç³»ç»Ÿå·²å°±ç»ªï¼Œè¯·ä¿æŒç½‘ç»œ";  
  
            } catch (err) {  
                console.error(err);  
                alert("å¯åŠ¨å¤±è´¥ï¼šè¯·æ£€æŸ¥éº¦å…‹é£æƒé™ã€‚\n(iOSè¯·ç”¨Safariï¼Œå®‰å“è¯·å°è¯•Chrome/Edge)");  
                els.btn.innerText = "é‡è¯•";  
                els.btn.disabled = false;  
                els.debug.innerText = "Error: " + err.message;  
            }  
        });  
  
        // === 1. éŸ³é‡ç›‘æ§ ===  
        function startVolumeLoop(stream) {  
            analyser = audioCtx.createAnalyser();  
            mic = audioCtx.createMediaStreamSource(stream);  
            scriptNode = audioCtx.createScriptProcessor(2048, 1, 1);  
            analyser.smoothingTimeConstant = 0.3;  
            analyser.fftSize = 1024;  
            mic.connect(analyser);  
            analyser.connect(scriptNode);  
            scriptNode.connect(audioCtx.destination);  
  
            scriptNode.onaudioprocess = () => {  
                if (!isRunning) return;  
  
                const array = new Uint8Array(analyser.frequencyBinCount);  
                analyser.getByteFrequencyData(array);  
                let values = 0;  
                for (let i=0; i<array.length; i++) values+=array[i];  
                const avg = values / array.length;  
                  
                let percent = Math.min(avg * 3, 100);  
                els.volBar.style.width = percent + "%";  
                if (percent > 80) els.volBar.classList.add('danger');  
                else els.volBar.classList.remove('danger');  
  
                const threshold = 115 - parseInt(els.slider.value);  
                if (avg > threshold) shoutFrames++;  
                else shoutFrames = Math.max(0, shoutFrames - 2);  
  
                if (shoutFrames > 15) {  
                    trigger('red', null);  
                    shoutFrames = 0;  
                }  
            };  
        }  
  
        // === 2. è¯­éŸ³è¯†åˆ« (é˜²å¡æ­»ç‰ˆ) ===  
        function initSpeechEngine() {  
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;  
            if (!SpeechRecognition) {  
                els.debug.innerText = "âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå¬å†™ (ä»…é™éŸ³é‡)";  
                return;  
            }  
  
            recognition = new SpeechRecognition();  
            recognition.continuous = false;   
            recognition.interimResults = true;  
            recognition.lang = 'zh-CN'; // è®¾ä¸ºä¸­æ–‡é€šå¸¸ä¹Ÿèƒ½è¯†åˆ«è‹±æ–‡ï¼Œå¦‚æœéœ€è¦çº¯è‹±æ–‡å¯æ”¹ en-USï¼Œä½† zh-CN æ··æ‚æ¨¡å¼æœ€å¥½  
              
            recognition.onstart = () => { els.dot.classList.add('on'); els.status.innerText = "æ­£åœ¨å¬..."; };  
              
            recognition.onend = () => {   
                els.dot.classList.remove('on');  
                if(isRunning) {  
                    setTimeout(() => { try { recognition.start(); } catch(e){} }, 200);  
                }  
            };  
  
            recognition.onerror = (event) => {  
                if (event.error !== 'no-speech') {  
                    console.log("Speech Error:", event.error);  
                    if(event.error === 'network') els.debug.innerText = "âŒ ç½‘ç»œè¿æ¥å¤±è´¥ (å¯èƒ½éœ€æ¢¯å­)";  
                }  
            };  
  
            recognition.onresult = (e) => {  
                let text = '';  
                for (let i = e.resultIndex; i < e.results.length; ++i) text += e.results[i][0].transcript;  
                if(text) {  
                    els.debug.innerText = "ğŸ‘‚: " + text.slice(-20); // æ˜¾ç¤ºæ›´å¤šå­—ç¬¦ä»¥ä¾¿è°ƒè¯•  
                    checkWords(text);  
                }  
            };  
  
            try { recognition.start(); } catch(e) {}  
        }  
  
        function checkWords(text) {  
            // 1. ç»Ÿä¸€è½¬ä¸ºå°å†™ï¼Œä»¥åŒ¹é…è‹±æ–‡å¤§å°å†™å·®å¼‚ (FUCK -> fuck)  
            const lowerText = text.toLowerCase();  
  
            if(lowerText.includes('*') || lowerText.includes('ï¼Š')) return trigger('yellow', "è„è¯(å·²å±è”½)");  
              
            for(let w of BAD_WORDS) {  
                // 2. è¿™é‡Œçš„ w å·²ç»åœ¨æ•°ç»„é‡Œæ˜¯å°å†™çš„äº†ï¼Œç›´æ¥æ¯”å¯¹  
                if(lowerText.includes(w)) {  
                    trigger('yellow', w);  
                    return;  
                }  
            }  
        }  
  
        // === 3. è§¦å‘è­¦å‘Š (ä¿®å¤æ’­æŠ¥è¯»ä¸å…¨çš„é—®é¢˜) ===  
        function trigger(mode, word) {  
            if (Date.now() - lastAlertTime < 3000) return;  
            lastAlertTime = Date.now();  
  
            // æš‚åœç›‘å¬  
            isRunning = false;   
            if(recognition) try{ recognition.stop(); } catch(e){}  
            els.dot.classList.remove('on');  
            els.status.innerText = "â›” è­¦å‘Šè§¦å‘ä¸­...";  
  
            els.overlay.className = `overlay mode-${mode} active`;  
            els.cardImg.src = (mode === 'yellow') ? IMAGES.YELLOW : IMAGES.RED;  
            els.title.innerText = (mode === 'yellow') ? "é»„ç‰Œè­¦å‘Šï¼" : "çº¢ç‰Œè­¦å‘Šï¼";  
              
            // === éšæœºæŠ½å–å¹½é»˜è¯­å½• ===  
            let tipsArray = (mode === 'yellow') ? FUNNY_TIPS.YELLOW : FUNNY_TIPS.RED;  
            let randomTip = tipsArray[Math.floor(Math.random() * tipsArray.length)];  
  
            let mainMsg = "";  
            if(mode === 'yellow') {  
                mainMsg = `æ£€æµ‹åˆ°æ•æ„Ÿè¯ï¼šã€${word}ã€‘`;  
            } else {  
                mainMsg = "å—“é—¨å¤ªå¤§äº†ï¼";  
            }  
  
            // ç»„åˆæ˜¾ç¤ºå†…å®¹ (å±å¹•æ˜¾ç¤ºä¿ç•™æ¢è¡Œ)  
            els.msg.innerText = mainMsg + "\n\nğŸ’¡ " + randomTip;  
              
            // æ’­æ”¾éŸ³æ•ˆ  
            try{ els.audio.currentTime=0; els.audio.play(); }catch(e){}  
              
            // === è¯­éŸ³æ’­æŠ¥é€»è¾‘ä¿®æ­£ ===  
            if(synth.speaking) synth.cancel();  
              
            let speakText = (mode === 'yellow') ? "è¯·æ³¨æ„è¯­è¨€æ–‡æ˜ã€‚" : "è¯·æ³¨æ„éŸ³é‡ã€‚";  
              
            // å…³é”®ä¿®æ”¹ï¼šæŠŠæ¢è¡Œç¬¦ \n æ›¿æ¢æˆé€—å·ï¼Œè¿™æ ·è¯­éŸ³å¼•æ“å°±ä¼šè¿è´¯è¯»ä¸‹å»ï¼Œè€Œä¸æ˜¯åœåœ¨ç¬¬ä¸€å¥  
            speakText += randomTip.replace(/\n/g, "ï¼Œ");   
  
            let u = new SpeechSynthesisUtterance(speakText);  
            u.lang = 'zh-CN';  
            synth.speak(u);  
        }  
  
        function dismissAlert() {  
            els.overlay.classList.remove('active');  
            synth.cancel();   
              
            els.debug.innerText = "é‡å¯ç›‘å¬ä¸­...";  
            shoutFrames = 0;  
            isRunning = true;  
              
            if (audioCtx.state === 'suspended') audioCtx.resume();  
  
            if (recognition) {  
                try { recognition.abort(); setTimeout(() => { try { recognition.start(); } catch(e){} }, 100); } catch(e) {}  
            }  
        }  
    </script>  
</body>  
</html>  
